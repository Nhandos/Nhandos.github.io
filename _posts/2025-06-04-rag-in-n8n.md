---
title: "RAG in N8N"
date: 2025-06-04 19:29:27 +0800
categories: Automation, Tutorial
tags: [n8n, llm, chatbot]
---

<!-- Write your post content here -->

## Goal

The goals of this experiment is to learn how to create an entry level RAG model
and then eventually dive deeper into ways how we can improve it. As such in
order to quantify if our RAG has improved, we must also come up with the
evaluation framework.

<!--
From a Youtube comment i saw:

1. Convert all the data into Markdown, then use Recursive Character Chunker with Markdown separators. 400 Characters with no overlap has proven to have the best recall and precision, while being really fast. (An alternative is using Cluster Semantic Chunker, it's more expensive and slow, but it's the best option for precision, Agentic chunker is not viable for scale as it's extremely slow and prohibitively expensive)
2. Use a fine-tuned embedding model (fine-tuned on domain data/examples)
3. Embed metadata into chunks, such as File name, page number, exact position on the page
4. Add a query re-writer/optimizer (and maybe a subquery generator)
It can get way more complex, using different techniques, but these things are what can fundamentally improve the recall and precision significantly.
Cheers, keep the good work up.
-->


So here's a break down of what I want to achieve in this particular excercise.

1. Build an entry-level RAG model
2. Create an an evaluation framework
3. Define potential future works/improvements

## Understanding RAG 

Imagine you have a document database, and you want an LLM to be able to answer
questions that requires context from those documents. Then RAG is an approach
whereby we search the document database for relevant text pertaining to
a user's query, and then embedded that context to the user's original query in
order to get a better result.

For example, if we had a document data base of insurance claims, and the user
asks the question.

*Prompt with No RAG == Poor Performance*
> What claims did Aisha Brown submitted?

If I was to just straightup send that prompt to ChatGPT it will definitely not
get the answer because it doens't have the relevant context. However, if I am
somehow able to fetch the relevant documents pertaining to Aisha Brown and then
augment my prompt with the context then my answer will be much better.

*Prompt with RAG == Great Performance*
> "System: You are an assistant for question-answering tasks. Use the following pieces of retrieved context to answer the question.\nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\n----------------\nContext: ## Field Report: Theft from Vehicle - Aisha Brown\n\n**Agent:** Unit 78, Regional Coverage\n\n**Date of Report:** 2024-06-14\n\n**Claimant:** Aisha Brown\n\n**Claim Number:** (To Be Assigned)\n\n**Date of Incident:** 2024-06-12\n\n**Type of Incident:** Theft from Vehicle\n\n**Location:** Unnamed roadside pull-over, approximately 15km north of Narrabri, NSW (GPS coordinates attached â€“ recorded at site). Described by claimant as a generally well-maintained but isolated lay-by area frequently used by truck drivers and touring vehicles.\n\n**Narrative Description:**\n\n## Field Report - Burglary Claim\n\n**Claimant:** Aisha Brown\n**Date of Incident:** 2024-11-03\n**Address of Incident:** Perth, WA\n\n**Type of Incident:** Burglary\n\n**Initial Narrative:**\n\nUpon arrival at the property at approximately 10:00 AM local time on 2024-11-04, I conducted an on-site inspection and interviewed Ms. Brown. Ms. Brown reports that she left the premises at approximately 8:00 AM on 2024-11-03 and returned at approximately 6:00 PM to discover signs of forced entry. The back door appeared to have been kicked in, with visible splintering around the doorjamb. Ms. Brown reported the following items missing: a 55-inch television, a laptop computer (make and model: Dell XPS 13), and a jewelry box containing assorted costume jewelry. A police report has been filed (report number provided by claimant: 20241103-WA-PD-789).\n\n**Observed Inconsistencies and Suspicious Elements:**\n\n4.  **Further Investigation of Claim History:** Conduct a thorough investigation of Ms. Brown's claim history to identify any patterns or prior claims related to weather damage. Clarify any discrepancies identified between previous claims and the current claim.\n\n**Conclusion:**\n\nFurther investigation is required to validate the claimant's account and determine the legitimacy of the claim. Discrepancies in the available information warrant a thorough and comprehensive investigation.\nHuman: What claims did Aisha Brown submitted?"


The challenge here is how do we build a system that given the user's input,
build some semantic understanding of the input and then searches our internal
database for a context that have semenatic similarity.

RAG achieves this by breaking the `corpus of documents` (i.e the knowledge
base) into smaller chunks of text. Then use an embedding model to convert these
chunks into vector embeddings that encode meaning, and then perform the search
against in vector storage against the user's input to find the `chunk` closest
in sementatic similarity.

Essentially, the user's prompt is turned into a vector embedding - this vector
will be queried against our vector document database, and the closest K vector
will be chosen to provide the necessary context. 3Blue1Brown has a great [short
video](https://www.youtube.com/shorts/FJtFZwbvkI4) on how vector embedding 
are associated with semantic understanding.

## Building a simple RAG

So am going to challenge my self a bit, and based on the on the description of
RAG above, i am going to try to build a RAG model. Here are the components
i think i will need.

1. A chunking system - we need to ingest our document databse and then figure
   out how to divide these into chunks of text in order to feed into our vector 
   databse out how to divide these into chunks of text in order to feed into our
   vector databse.There's already a few challenges i think i will encounter:
    * How do we determine a chunk so that we can maximally include all the
      relevent context in the same chunk? i.e. we don't want our chunking to
      happen at the border of a paragraph that would remove important context.
    * Size of chunk matters?
    
2. Embedding Model: Turn chunks into vector embedding
3. Vector database: Store embeddings from database, and has the ability to
   search.
4. LLM - send to LLM user input + context

## Stack 

This is the stack I am going to use:

1. **For chunking** I am going to to write a python script to do that.
2. **For vector store, indexing, and index search** I am going to use [Pinecone](https://www.pinecone.io/).
3. **n8n** will be the interface and glue everything together.

## Collecting some data

We need a dataset to perform RAG over. This dataset should contain specific
information that is not readily available on the internet yet should remain in
in a domain that the LLM has been trained on.

For the `document database`, I've decided to go with `Google Sheets` for it's
simplicity and readily available integration with `n8n`. I followed this
[guide](https://docs.n8n.io/integrations/builtin/credentials/google/oauth-single-service/) in order to setup credentials.


## N8N workflow setup

I think we will need the following workflow.
1. **Data mocking**: This pipeline will use an LLM to create a databse of mock
   documents for us to work with.
2. **Chunking & Indexing**: Perform chunking and indexing on our mock dataset and then store it in
   a vector store.
3. **RAG chatbot**: This is the workflow with a chat interface that user's will
   be able to query data from.
4. **Evaluation**: This workflow performs evaluation, I'd imagine it will run
   the chatbot workflow to evaluate how well our RAG perform (we will use
   precision/recall metrics to evaluate the model.)


## Mocking documents

I've decided to mock insurance data reports to be my document database.
I've written a python script to generate random parameters that will feed into
a prompt. 

First a python script is used to generate random paramters to create our
prompt.
```python
import random
from datetime import datetime, timedelta

incident_types = [
    "car accident", "flood damage", "burglary", "fire loss",
    "personal injury", "storm damage", "theft from vehicle", "water leak", "hail damage"
]

locations = [
    "Perth, WA", "Brisbane, QLD", "rural NSW", "Sydney CBD", "Gold Coast",
    "Melbourne, VIC", "Adelaide, SA", "Darwin, NT", "Hobart, TAS", "Canberra, ACT"
]

first_names = [
    "John", "Tina", "Mohammed", "Eliza", "Tommy", "Natalie", "Raj", "Sophie", "Jacob", "Linda",
    "Grace", "Lucas", "Aisha", "Dylan", "Mei", "Ethan", "Amelia", "Noah", "Liam", "Zara"
]

last_names = [
    "Barnes", "Ho", "Faisal", "Chen", "Singh", "Brooks", "Patel", "Nguyen", "Wallace", "Park",
    "Smith", "Brown", "Taylor", "Williams", "Jones", "Davis", "Lee", "Martin", "Clark", "Evans"
]

def generate_random_name():
    return f"{random.choice(first_names)} {random.choice(last_names)}"

def random_date_within_last_year():
    days_ago = random.randint(0, 365)
    date = datetime.now() - timedelta(days=days_ago)
    return date.strftime("%Y-%m-%d")

for item in _input.all():
    item.json.incident_type = random.choice(incident_types)
    item.json.location = random.choice(locations)
    item.json.claimant_name = generate_random_name()
    item.json.incident_date = random_date_within_last_year()

return _input.all()
```

... then it is random paramters are unpacked into this prompt which is then fed
to an LLM and saved to our google sheets.
```md
Generate an unstructured insurance claim report from the perspective of an insurance field agent. The report should include:
- The type of incident: [[ $json.incident_type ]]
- The data of incident: [[ $json.incident_date ]]
- The location: [[ $json.location ]]
- The claimant's name: [[ $json.claimant_name ]]
- A brief narrative description of what happened
- Any suspicious elements or inconsistencies
- Recommended next steps

The tone should be professional and observational, not emotional. It should be in markdown format and be no longer than 1 page
```

Below is a sample of the generated document stored in my google sheets

```md
## Field Report - Burglary Claim

**Claimant:** Aisha Brown
**Date of Incident:** 2024-11-03
**Address of Incident:** Perth, WA

**Type of Incident:** Burglary

**Initial Narrative:**

Upon arrival at the property at approximately 10:00 AM local time on 2024-11-04, I conducted an on-site inspection and interviewed Ms. Brown. Ms. Brown reports that she left the premises at approximately 8:00 AM on 2024-11-03 and returned at approximately 6:00 PM to discover signs of forced entry. The back door appeared to have been kicked in, with visible splintering around the doorjamb. Ms. Brown reported the following items missing: a 55-inch television, a laptop computer (make and model: Dell XPS 13), and a jewelry box containing assorted costume jewelry. A police report has been filed (report number provided by claimant: 20241103-WA-PD-789).

**Observed Inconsistencies and Suspicious Elements:**

*   **Lack of Significant Disruption:** While the back door showed signs of forced entry, the damage appeared to be relatively minimal, particularly given the reported value of the stolen items. The doorjamb was splintered, but the door itself was still relatively secure within the frame. Further investigation into the force required to cause the observed damage is recommended.

*   **Specificity of Stolen Items:** Ms. Brown was able to provide a precise make and model number for the laptop computer. However, when questioned about the specific contents of the jewelry box, she was less certain, stating the contents were "assorted costume jewelry" but unable to provide a detailed list or estimated value. This discrepancy warrants further investigation of ownership and value.

*   **Neighborhood Security:** While speaking to a neighbor (Mr. David Lee, address adjacent to Ms. Brownâ€™s), I learned that several other burglaries have been reported in the area in the past month. Mr. Lee indicated that none of the previous incidents involved forced entry; they were all attributed to unlocked doors or windows. This raises the possibility that Ms. Brown may have also left the back door unlocked, although she vehemently denies doing so.

**Recommended Next Steps:**

1.  **Forensic Evaluation of Door:** Engage a forensic expert to examine the back door and doorjamb to determine the likely amount of force required to cause the observed damage. This will help determine if the damage is consistent with forced entry or a staged event.

2.  **Verification of Ownership and Value:** Request documentation (receipts, appraisals, purchase records) to verify Ms. Brown's ownership and the value of the claimed items, particularly the Dell XPS 13 laptop and the contents of the jewelry box. A detailed appraisal of the jewelry may be necessary.

3.  **Police Report Follow-Up:** Contact the Perth Police Department to obtain a copy of the police report and inquire about the progress of their investigation. Determine if any suspects have been identified or if there are similarities to other recent burglaries in the area.

4.  **Neighborhood Canvassing (Secondary):** Conduct further interviews with neighbors beyond Mr. Lee to gather additional information about suspicious activity in the area and to ascertain if anyone witnessed anything relevant to the reported burglary.

5.  **Background Check:** A standard background check on Ms. Brown is recommended to assess any prior claims history or potential red flags.

End of Report
```

## Indexing and Vector store pipeline

![Alt Text](./assets/posts/rag-in-n8n/rag_indexing_pipeline.png)

To run this pipeline, the following pre-requisites must be met:
* Google Sheets Credentials (Created in the previous step)
* Google Gemini Credentials (I.e Google Gemini's API key)
* Pinecone Credentials (I.E Pinecone's API key)
* Pinecone index created. (See [Create an index in Pinecone](#create-an-index-in-pinecone))

This pipeline consists of these nodes:
1. **Google Sheets**: Fetching documents from our database
2. **Pinecone Vector Store**: Orchestrate the indexing process.
3. **Embeddings Google Gemini**: This is the embedding model that the Pinecone
   node uses.
4. **Default Data Loader**: This node allows us to control how our document(s) are
   chunked.

Once the pipeline is ran, all of our documents will be indexed and uploaded to
Pinecone. Below is a screenshot of the our records stored in Pinecone vector
database.

![Alt Text](./assets/posts/rag-in-n8n/rag_index_in_pinecone.png)

... and we can inspect each record to see it's Dense vector value, the original
text that created this embedding.

![Alt Text](./assets/posts/rag-in-n8n/rag_record_in_pinecone.png)

### Create an index in Pinecone

You should navigate to the page that resembles something like this screen shot
below
Follow these steps to create the index
1. Enter the name of the index
2. For `Embedding method`, select `External Embedding`
3. For `Index configuration`, select **Dense** Vector type, **768** as the
   Dimension and **cosine** as the metric.
4. Leave the rest as defaults and proceed to create your index.

## Chatbot pipeline

![Alt Text](./assets/posts/rag-in-n8n/rag_chatbot_pipeline.png)

This pipeline combines everything together so we can execute whenever a chat is
input.

For example, when the user asks the question,

```
can you give a summary of the claims made by Aisha Brown?
```

The first thing that will happen is we create a vector embedding of the user's
prompt using **the same vector embedding model used by our vector database**.

![Alt Text](./assets/posts/rag-in-n8n/rag_embedding.png)

Next, this vector is used to search our vector database to return the closest
K vectors. These K vector should in theory carry some semantic similarity to
our query vector.

![Alt Text](./assets/posts/rag-in-n8n/rag_pinecone_query.png)

The context is combined with the system prompt in a typical LLM query
to return the answer to the user. Inspecting the node, I can see that N8N used
the following prompt:

> "System: You are an assistant for question-answering tasks. Use the following pieces of retrieved context to answer the question.\nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\n----------------\nContext: ## Field Report: Theft from Vehicle - Aisha Brown\n\n**Agent:** Unit 78, Regional Coverage\n\n**Date of Report:** 2024-06-14\n\n**Claimant:** Aisha Brown\n\n**Claim Number:** (To Be Assigned)\n\n**Date of Incident:** 2024-06-12\n\n**Type of Incident:** Theft from Vehicle\n\n**Location:** Unnamed roadside pull-over, approximately 15km north of Narrabri, NSW (GPS coordinates attached â€“ recorded at site). Described by claimant as a generally well-maintained but isolated lay-by area frequently used by truck drivers and touring vehicles.\n\n**Narrative Description:**\n\n## Field Report - Burglary Claim\n\n**Claimant:** Aisha Brown\n**Date of Incident:** 2024-11-03\n**Address of Incident:** Perth, WA\n\n**Type of Incident:** Burglary\n\n**Initial Narrative:**\n\nUpon arrival at the property at approximately 10:00 AM local time on 2024-11-04, I conducted an on-site inspection and interviewed Ms. Brown. Ms. Brown reports that she left the premises at approximately 8:00 AM on 2024-11-03 and returned at approximately 6:00 PM to discover signs of forced entry. The back door appeared to have been kicked in, with visible splintering around the doorjamb. Ms. Brown reported the following items missing: a 55-inch television, a laptop computer (make and model: Dell XPS 13), and a jewelry box containing assorted costume jewelry. A police report has been filed (report number provided by claimant: 20241103-WA-PD-789).\n\n**Observed Inconsistencies and Suspicious Elements:**\n\n4.  **Further Investigation of Claim History:** Conduct a thorough investigation of Ms. Brown's claim history to identify any patterns or prior claims related to weather damage. Clarify any discrepancies identified between previous claims and the current claim.\n\n**Conclusion:**\n\nFurther investigation is required to validate the claimant's account and determine the legitimacy of the claim. Discrepancies in the available information warrant a thorough and comprehensive investigation.\nHuman: can you give a summary of the claims made by Aisha Brown"

Finally, the chatbot returns

> { "response": "Aisha Brown made two claims:\n\n1. Theft from Vehicle: On 2024-06-12, Aisha Brown reported a theft from her vehicle at an unnamed roadside pull-over approximately 15km north of Narrabri, NSW.\n2. Burglary: On 2024-11-03, Aisha Brown reported a burglary at her property in Perth, WA. Missing items include a 55-inch television, a Dell XPS 13 laptop, and a jewelry box with costume jewelry.\n" }

if we examine our Google Docs, we can find two entry for Aisha Brown, and it
resembles our answer.

the first claim that Aisha made,

```md
## Field Report - Burglary Claim

**Claimant:** Aisha Brown
**Date of Incident:** 2024-11-03
**Address of Incident:** Perth, WA

**Type of Incident:** Burglary

**Initial Narrative:**

Upon arrival at the property at approximately 10:00 AM local time on 2024-11-04, I conducted an on-site inspection and interviewed Ms. Brown. Ms. Brown reports that she left the premises at approximately 8:00 AM on 2024-11-03 and returned at approximately 6:00 PM to discover signs of forced entry. The back door appeared to have been kicked in, with visible splintering around the doorjamb. Ms. Brown reported the following items missing: a 55-inch television, a laptop computer (make and model: Dell XPS 13), and a jewelry box containing assorted costume jewelry. A police report has been filed (report number provided by claimant: 20241103-WA-PD-789).

**Observed Inconsistencies and Suspicious Elements:**

*   **Lack of Significant Disruption:** While the back door showed signs of forced entry, the damage appeared to be relatively minimal, particularly given the reported value of the stolen items. The doorjamb was splintered, but the door itself was still relatively secure within the frame. Further investigation into the force required to cause the observed damage is recommended.

*   **Specificity of Stolen Items:** Ms. Brown was able to provide a precise make and model number for the laptop computer. However, when questioned about the specific contents of the jewelry box, she was less certain, stating the contents were "assorted costume jewelry" but unable to provide a detailed list or estimated value. This discrepancy warrants further investigation of ownership and value.

*   **Neighborhood Security:** While speaking to a neighbor (Mr. David Lee, address adjacent to Ms. Brownâ€™s), I learned that several other burglaries have been reported in the area in the past month. Mr. Lee indicated that none of the previous incidents involved forced entry; they were all attributed to unlocked doors or windows. This raises the possibility that Ms. Brown may have also left the back door unlocked, although she vehemently denies doing so.

**Recommended Next Steps:**

1.  **Forensic Evaluation of Door:** Engage a forensic expert to examine the back door and doorjamb to determine the likely amount of force required to cause the observed damage. This will help determine if the damage is consistent with forced entry or a staged event.

2.  **Verification of Ownership and Value:** Request documentation (receipts, appraisals, purchase records) to verify Ms. Brown's ownership and the value of the claimed items, particularly the Dell XPS 13 laptop and the contents of the jewelry box. A detailed appraisal of the jewelry may be necessary.

3.  **Police Report Follow-Up:** Contact the Perth Police Department to obtain a copy of the police report and inquire about the progress of their investigation. Determine if any suspects have been identified or if there are similarities to other recent burglaries in the area.

4.  **Neighborhood Canvassing (Secondary):** Conduct further interviews with neighbors beyond Mr. Lee to gather additional information about suspicious activity in the area and to ascertain if anyone witnessed anything relevant to the reported burglary.

5.  **Background Check:** A standard background check on Ms. Brown is recommended to assess any prior claims history or potential red flags.

End of Report
```
the second claim that Aisha made

```
## Field Report: Theft from Vehicle - Aisha Brown

**Agent:** Unit 78, Regional Coverage

**Date of Report:** 2024-06-14

**Claimant:** Aisha Brown

**Claim Number:** (To Be Assigned)

**Date of Incident:** 2024-06-12

**Type of Incident:** Theft from Vehicle

**Location:** Unnamed roadside pull-over, approximately 15km north of Narrabri, NSW (GPS coordinates attached â€“ recorded at site). Described by claimant as a generally well-maintained but isolated lay-by area frequently used by truck drivers and touring vehicles.

**Narrative Description:**

Claimant, Aisha Brown, reports parking her 2021 Toyota RAV4 (Registration ABC-123) at the aforementioned location at approximately 13:00 on 2024-06-12. Ms. Brown states she left the vehicle unattended for a period of approximately one hour to engage in hiking along a nearby track. Upon returning to the vehicle at approximately 14:00, she discovered the rear passenger side window had been shattered. Numerous items inside the vehicle were missing, including:

*   One (1) Apple MacBook Pro (16 inch, 2021 model) - Serial Number provided separately.
*   One (1) Louis Vuitton Monogram Neverfull GM handbag - No serial number available.
*   Assorted travel documents (Passport, driver's license, etc.) â€“ Claimant has provided copies of these documents separately.
*   Approximately $300 AUD in cash.

Ms. Brown contacted local police (Narrabri Police Station) who attended the scene and took a statement. Incident report number is pending. Damage to the vehicle consists solely of the shattered rear passenger side window. No other points of entry appear to have been compromised. Claimant secured the vehicle with temporary patching provided by a passing motorist.

**Suspicious Elements/Inconsistencies:**

*   **High-Value Items Left Visible:** The claimant stated the handbag containing the Macbook Pro was positioned on the rear passenger seat, clearly visible from the exterior of the vehicle. This seems atypical given the isolated location and the inherent risk of theft.
*   **Lack of Other Signs of Disturbance:** The area immediately surrounding the vehicle showed no obvious signs of disturbance beyond the shattered glass. No footprints or discarded items were apparent, suggesting a potentially quick and efficient operation.
*   **Specificity of Lost Items:** While the claimant provided the serial number for the MacBook Pro, she was unable to recall any identifying features of the handbag, further than its model and style. While not inherently suspicious, it warrants further scrutiny.
*   **Limited Wi-Fi/Cell Service:** The claimant stated that she was unable to call or use location based services due to low or no Wi-Fi or cellular data coverage. This is potentially true based on geographical conditions, although testing signal strength at the specific coordinates is advised.

**Recommended Next Steps:**

*   **Obtain Narrabri Police Incident Report:** Crucial to verify the claimant's statement and ascertain any findings of their investigation.
*   **Contact Witness Contacted:** Claimant said she contacted a passing motorist to assist in securing the vehicle. Identify and interview this witness. Focus on verifying time frames.
*   **Review Claimant's Social Media:** Check for any relevant posts or activity around the date of the incident, including any mentions of travel plans or recent acquisitions.
*   **Verification of Ownership:** Confirm ownership of the specified items via purchase receipts or other relevant documentation.
*   **Assess Comparable Claims:** Review historical claim data for similar theft incidents in the Narrabri region to identify any patterns or trends.
*   **Consider Formal Interview:** Based on initial findings, a formal interview with the claimant may be necessary to address the identified inconsistencies and clarify details.
```




## Evaluation pipeline

TODO
